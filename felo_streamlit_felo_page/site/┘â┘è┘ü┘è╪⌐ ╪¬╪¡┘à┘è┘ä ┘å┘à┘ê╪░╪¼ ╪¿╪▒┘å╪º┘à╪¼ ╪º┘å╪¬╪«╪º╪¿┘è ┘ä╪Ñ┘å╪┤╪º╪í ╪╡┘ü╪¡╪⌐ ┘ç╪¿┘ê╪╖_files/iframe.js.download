"use strict";(()=>{(function(){let v,ze=document.currentScript,ve={getVersion:()=>Number(ze.dataset.version)||0},Oe=["http://localhost:3000",/^https:\/\/([a-zA-Z0-9-]+\.)*felo\.ai$/,/^https:\/\/([a-zA-Z0-9-]+\.)*felo\.me$/],$e="html,body{margin:0 !important;padding:0 !important;}",ke=e=>Oe.some(t=>typeof t=="string"?t===e:t.test(e)),_={IframeSize:"felo.ai.iframe.size",ShowLoading:"SHOW_LOADING",HideLoading:"HIDE_LOADING",RequestEditPermission:"REQUEST_EDIT_PERMISSION",EditPermissionResponse:"EDIT_PERMISSION_RESPONSE",CleanupHoverSelection:"CLEANUP_HOVER_SELECTION",TriggerSave:"TRIGGER_SAVE",SetEditingPaused:"SET_EDITING_PAUSED",ELEMENT_DRAG_START:"ELEMENT_DRAG_START",ELEMENT_RESIZE_START:"ELEMENT_RESIZE_START",ELEMENT_SELECTION_CHANGE:"ELEMENT_SELECTION_CHANGE",ELEMENT_SCREENSHOT:"ELEMENT_SCREENSHOT",FULL_REINITIALIZE:"FULL_REINITIALIZE",IMAGE_REPLACED:"IMAGE_REPLACED"},w=null,h=null,I=null,F=null,j=null,f=null,R=!1,k=!1,V=!1,J=!1,Ne=1,Ce,M={mouseover:null,mouseout:null,click:null},re=null;function We(e){return Object.prototype.toString.call(e)==="[object String]"}function G(e){if(!e||!(e instanceof Element))return{top:0,right:0,bottom:0,left:0};let t=window.getComputedStyle(e),n=parseInt(t.paddingTop),o=parseInt(t.paddingRight),i=parseInt(t.paddingBottom),s=parseInt(t.paddingLeft);return{top:n,right:o,bottom:i,left:s}}function U(e){if(!e||!(e instanceof Element))return{top:0,right:0,bottom:0,left:0};let t=window.getComputedStyle(e),n=parseInt(t.marginTop),o=parseInt(t.marginRight),i=parseInt(t.marginBottom),s=parseInt(t.marginLeft);return{top:n,right:o,bottom:i,left:s}}function O({type:e,...t}){try{let n={};Object.keys(t).forEach(i=>{try{let s=t[i];s==null||typeof s=="string"||typeof s=="number"||typeof s=="boolean"?n[i]=s:(Array.isArray(s)||typeof s=="object")&&(JSON.parse(JSON.stringify(s)),n[i]=s)}catch(s){console.warn(`Skipping non-serializable value for key "${i}":`,s)}});let o={type:e,url:window.location.href,pathname:window.location.pathname,pageId:Ce,...n};window.parent.postMessage(o,"*")}catch(n){console.error("Failed to post message to parent:",n)}}async function ae(){try{let e=document?.documentElement?.querySelector("div.slide-container")?.clientHeight||document?.documentElement?.querySelector("div.slide")?.clientHeight||document?.documentElement?.scrollHeight||document?.body?.scrollHeight,t=document?.documentElement?.querySelector("div.slide-container")?.clientWidth||document?.documentElement?.querySelector("div.slide")?.clientWidth||document?.documentElement?.scrollWidth||document?.body?.scrollWidth;O({type:_.IframeSize,height:e,width:t})}catch(e){console.error(e)}}function Ee(){document.querySelectorAll("[_echarts_instance_]")?.forEach(t=>{let n=t.getAttribute("_echarts_instance_");if(!n)return;let o=window?.echarts?.getInstanceById(n);o&&o?.resize({animation:!1})})}function qe(e){if(!e||!(e instanceof Element))return[];let t=['[class*="text-"]'].join(", "),n=e.querySelectorAll(t),o=Ve(e);return n=[...n,...o],Array.from(n)?.filter(i=>{if(!i||!(i instanceof Element))return!1;let s=i?.className;return!s||!We(s)?!1:!s?.includes("fa-")})}function De(e){if(!e||!(e instanceof Element))return;let t=e.querySelectorAll("img");return Array.from(t).filter(n=>{if(!n||!(n instanceof Element))return!1;try{let o=window.getComputedStyle(n),i=parseInt(o.height)||0;return n.style.height=`${i}px`,!0}catch(o){return console.warn("Failed to get computed style for image:",o),!1}})}let Be=({newFontSize:e,oldFontStyle:t,scale:n,fontScale:o=1.25,newLineHeight:i})=>{let d=(e>t?.fontSize?t?.fontSize/n:e)*o;d=n*d*o,d=d*n>t?.fontSize?t?.fontSize/n:d,d=d<14/n?14/n:d;let r=(i>t?.lineHeight?t?.lineHeight/n:i)*o;return r=n*r*o,r=r*n>t?.lineHeight?t?.lineHeight/n:r,r=r/d<1.3?d*1.3:r,{fontSize:d,lineHeight:r}};function je(e){if(!e||!(e instanceof Element))return[];let t=[];try{let n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(i){return/\S/.test(i.nodeValue)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}}),o;for(;o=n.nextNode();)t.push(o)}catch(n){console.warn("Failed to create tree walker:",n)}return t}function Ve(e){if(!e||!(e instanceof Element))return[];let t=je(e),n=[];return t.forEach(o=>{let i=o?.parentElement;if(!i||!(i instanceof Element))return;let m=Array.from(i?.classList).some(r=>r?.includes("text-")),d=i.closest("svg")!==null;!m&&!d&&n.push(i)}),n}function we(e,t=1){if(!e||!(e instanceof Element))return;e.querySelectorAll("img")?.forEach(o=>{if(!o||!(o instanceof Element))return;let i=o?.parentElement;if(!(!i||!(i instanceof Element)))try{let s=window.getComputedStyle(i),m=parseInt(s.height)||0,d=G(i),r=Array.from(i?.childNodes),y=0,p=0;r.forEach(a=>{if(a.nodeType===Node.ELEMENT_NODE){if(!(a instanceof Element))return;if(a.tagName.toLowerCase()!=="img")try{let S=window.getComputedStyle(a),g=a?.clientHeight||0,c=U(a),u=c.top,E=c.bottom;y+=g+u+E}catch(S){console.warn("Failed to get computed style for node:",S)}else try{let S=window.getComputedStyle(a),g=a?.clientHeight||0,c=U(a),u=c.top,E=c.bottom;y+=u+E,p+=g}catch(S){console.warn("Failed to get computed style for image node:",S)}}else if(a.nodeType===Node.TEXT_NODE){let S=a.textContent.trim();if(S){let g=document.createElement("span");g.style.visibility="hidden",g.style.position="absolute",g.textContent=S;try{let c=window.getComputedStyle(i);g.style.font=c.font,g.style.lineHeight=c.lineHeight,g.style.whiteSpace="pre-wrap",g.style.width=c.width,document.body.appendChild(g),y+=g.offsetHeight,document.body.removeChild(g)}catch(c){console.warn("Failed to get computed style for parent:",c),document.body.removeChild(g)}}}});let N=m-d.top-d.bottom-y,l=i?.querySelectorAll("img");l?.forEach((a,S)=>{if(!a||!(a instanceof Element))return;let c=(a?.clientHeight||0)/p||1,u=i?.parentElement;if(l.length===1&&u&&Array.from(u.childNodes).filter(x=>x.nodeType===Node.ELEMENT_NODE).length===1){let x=window.getComputedStyle(u),W=parseInt(x.height)||0,te=G(u),X=W-te.top-te.bottom;a.style.height=`${X}px`,a.style.maxHeight=`${X}px`,a.style.objectFit="contain";return}let E=c*N;a.style.height=`${E}px`,a.style.maxHeight=`${E}px`})}catch(s){console.warn("Failed to process image height:",s)}})}function Ge(e,t=1){!e||!(e instanceof Element)||e.querySelectorAll('[class*="max-w-"]')?.forEach(n=>{if(!n||!(n instanceof Element)||n.classList.contains("max-w-full"))return;let i=window.getComputedStyle(n),s=parseInt(i?.maxWidth);if(isNaN(s))return;let m=s/t;setTimeout(()=>{n.style.maxWidth=`${m}px`},100)})}function Ue(e){!e||e instanceof Element}function Ye(e){let t=window.getComputedStyle(e);if(t.backgroundImage&&t.backgroundImage!=="none")return!0;let n=e.querySelectorAll("*");for(let o of n){let i=window.getComputedStyle(o);if(i.backgroundImage&&i.backgroundImage!=="none")return!0}return!1}function Xe(e){if(!e||!(e instanceof Element)||e?.style?.transform?.includes("scale"))return;e.querySelectorAll("*").forEach(n=>{if(!n||!(n instanceof Element))return;let o=n.id||"";if(o&&o.toLocaleLowerCase().includes("chart"))return;let i=n?.parentElement,s=i?.querySelector('[id$="chart"] i')!==null;i&&i instanceof Element&&s||n.classList&&Array.from(n.classList).filter(m=>{if(m.startsWith("h-")){let d=m.substring(2),r=parseInt(d);return!isNaN(r)&&r<=40?!1:!Ye(n)}return!1}).forEach(m=>n.classList.remove(m))})}function Ze(e,t){if(!e||!(e instanceof Element))return!1;let n=Array.from(document.styleSheets);for(let o of n)try{let i=Array.from(o.cssRules||o.rules||[]);for(let s of i)if(s instanceof CSSStyleRule&&e.matches(s.selectorText)){if(t==="height")return s.style[t]&&s.style[t]!=="auto";if(s.style[t]&&s.style[t]!=="")return!0}}catch(i){console.warn("Failed to access style sheet:",i)}return!1}class Je{constructor(t){this.el=t}fontSizes=[15,14.5,14,13.5,13,12.5,12,11.5,11,10.5,10];checkSmartArtIsOverflow(){let t=v.slide?G(v.slide):{top:0,bottom:0},n=Math.round((t.top+t.bottom)/1.25),o=720,i=v.header?.clientHeight||0,s=v.main?.clientHeight||0,m=v.main?G(v.main):{top:0,bottom:0},d=this.el.clientHeight||0;if(Ze(v.main,"height")){let l=s-m.top-m.bottom-n-16;return d>l}let y=v.header?U(v.header).bottom:0,p=v.main?U(v.main).top:0;return i+y+p+d+m.top+m.bottom+n-16>o}init(t=0){if(t>10)return;let n=this.fontSizes[t];this.el.style.fontSize=`${n}px`,this.checkSmartArtIsOverflow()&&this.init(t+1)}}function Y(e){!e||!(e instanceof Element)||(e.dataset.scaleDone="true")}function Ke(e){let t=e?.main;return!t||!(t instanceof Element)?!1:e?.header&&e.header instanceof Element?t.contains(e.header):!!t.querySelector(".slide--header, header")}function Qe(){if(v.main?.dataset?.scaleDone==="true")return;if((v.main?.dataset?.scaleMode||"auto")==="em"){let t=v.main?.querySelector(".slide--art");t&&t instanceof Element&&new Je(t).init(),Y(v.main)}}function le(e=0,t=30,n=1,o=[],i=0,s=0,m=[]){console.log("\u{1F680} ~ fixHeight ~ recursionCount:",e,t,n);function d(){let N=v.header?.clientHeight||0,l=v.main?.clientHeight||0;return N+l-15>720}let r=[15,14.5,14,13.5,13,12.5,12,11.5,11,10.5,10];function y(p=0){if(p>10)return;let N=v.main?.querySelector(".slide--art"),l=r[p];N&&N instanceof Element&&(N.style.fontSize=`${l}px`),d()&&y(p+1)}try{let p=document.documentElement.querySelector(".slide");Ue(p);let N=p?.classList?.contains("flex")&&p?.classList?.contains("flex-col"),l=document.documentElement.querySelector(".slide--main");if(l?.dataset?.scaleDone==="true")return;let a=l?.classList?.contains("justify-center"),S=l?.classList?.contains("items-center"),g=l?.dataset?.scaleFontSize==="false",c=l?.dataset?.scaleMode||"auto";Xe(l);let u=l?.parentElement,E=null;try{u&&u instanceof Element&&(E=window.getComputedStyle(u))}catch(P){console.warn("Failed to get main parent computed style:",P)}let H=u?.classList?.contains("justify-center")||E?.alignItems==="center"||u?.classList?.contains("items-center"),L=u?.classList?.contains("justify-center")||E?.justifyContent==="center",x=u?.classList?.contains("items-center")||E?.alignItems==="center",W=G(l?.parentElement);if((H||a)&&l?.querySelectorAll('[class*="max-w-"]')?.forEach(P=>{!P||!(P instanceof Element)||Array.from(P.classList).filter(z=>z.includes("max-w")).forEach(z=>{P.classList.remove(z)})}),e>=t||Math.floor(n*10)<=1){we(l,n),Y(l);return}if(l?.style?.transform?.includes("scale")&&(l.style.height="auto"),De(l),Ge(l,n),c==="em"){y(),Y(l);return}let te=p?.clientHeight||0,$=G(p),X=v.header?.clientHeight||0,he=U(v.header),ge=v.header?.lastElementChild,ne=U(ge),q=l?.clientHeight||0;console.log("\u{1F680} ~ fixHeight ~ mainHeight:",q);let pe=l?.clientWidth||0,Se=G(l),D=U(l),A=Ke(v)?720-$.top-$.bottom-D.top-D.bottom-ne.bottom:720-$.top-$.bottom-X-he.top-he.bottom-D.top-D.bottom-ne.bottom;if(A=$.bottom+D.bottom<20&&D.bottom+$.bottom<20?A-20:A,A<=0){Y(l);return}console.log("\u{1F680} ~ fixHeight ~ headerHeight/mainHeight/maxMainHeight:",X,q,A);let K=m.length>0?m:qe(l),oe=o.length>0?o:K.map(P=>{if(!P||!(P instanceof Element))return{fontSize:0,lineHeight:0};try{let z=window.getComputedStyle(P);return{fontSize:parseInt(z?.fontSize)||0,lineHeight:parseInt(z?.lineHeight)||0}}catch(z){return console.warn("Failed to get computed style for element:",z),{fontSize:0,lineHeight:0}}}),B=1;if(q>A){B=A/q;let P=x&&i+W.left+W.right<=1280?"center":"left",z=L?"center":"top";Ne=B,l.style.transform=`scale(${B})`,l.style.transformOrigin=`${P} ${z}`,l.style.height=`${q}px`;let C=`${(i||pe)*(q/A)}px`;if(l.style.width=C,l.style.maxWidth=C,g){Y(l);return}if(K.forEach((T,ye)=>{if(!T||!(T instanceof Element))return;let ie=oe[ye]??0,se=q/A;try{let Z=window.getComputedStyle(T),b=parseInt(Z?.fontSize)||0,be=parseInt(Z?.lineHeight)||0,ft=b*se,mt=be*se,ht=1.25,{fontSize:gt,lineHeight:pt}=Be({newFontSize:ft,oldFontStyle:ie,scale:B,fontScale:ht,newLineHeight:mt});T.style.fontSize=`${gt}px`,T.style.lineHeight=`${pt}px`}catch(Z){console.warn("Failed to process element style:",Z)}}),B===n){we(l,B),Y(l);return}setTimeout(()=>{le(e+1,t,B,oe,i||pe,A,K)},10)}else{we(l,B),Y(l);return}}catch(p){console.error(p)}}function et(e,t){let n;return function(...i){let s=()=>{clearTimeout(n),e(...i)};clearTimeout(n),n=setTimeout(s,t)}}function Ie(){let e=document.getElementById("felo-iframe-styles");e||(e=document.createElement("style"),e.id="felo-iframe-styles",document.head.appendChild(e)),e.textContent=$e,v={slide:document.documentElement.querySelector(".slide"),header:document.documentElement.querySelector(".slide--header"),main:document.documentElement.querySelector(".slide--main")},J||(J=!0,setTimeout(()=>{ce()},100)),ve.getVersion()===0?le():ve.getVersion()===2&&Qe(),setTimeout(()=>{ae(),Ee();let t=document.querySelector("script[src*='iframe.js']");if(t&&t.src){let n=new URL(t.src);n.searchParams.set("v",Date.now()),t.src=n.toString()}},100)}function ce(e=0){try{O({type:_.RequestEditPermission}),e<1&&setTimeout(()=>{R===!1&&e<1&&ce(e+1)},3e3)}catch(t){console.error("Failed to request edit permission:",t),e<1?setTimeout(()=>ce(e+1),1e3):R=!1}}function tt(e){let t=R;if(R=e,document.body&&(document.body.contentEditable=e?"true":"false"),t!==R)if(R)try{fe()}catch(n){console.error("Failed to initialize hover selection:",n)}else try{ue()}catch(n){console.error("Failed to cleanup hover selection:",n)}}function Te(){if(console.log("[FELO-IFRAME] Reinitializing iframe..."),J=!1,Ie(),R)try{fe()}catch(e){console.error("Failed to reinitialize hover selection:",e)}}function He(){console.log("[FELO-IFRAME] Full reinitializing iframe...");try{ue(),w=null,h=null,I=null,j=null,f=null,F=null,k=!1,V=!1,J=!1,Ne=1,v={slide:document.documentElement.querySelector(".slide"),header:document.documentElement.querySelector(".slide--header"),main:document.documentElement.querySelector(".slide--main")},le(),setTimeout(()=>{Ee()},100),setTimeout(()=>{ae()},100),J||(J=!0,setTimeout(()=>{ce()},200)),R&&setTimeout(()=>{try{fe()}catch(e){console.error("Failed to reinitialize hover selection:",e)}},300),setTimeout(()=>{let e=document.querySelector("script[src*='iframe.js']");if(e&&e.src){let t=new URL(e.src);t.searchParams.set("v",Date.now()),e.src=t.toString()}},100),console.log("[FELO-IFRAME] Full reinitialization completed")}catch(e){console.error("[FELO-IFRAME] Error during full reinitialization:",e)}}function de(){w&&(w.style.display="none"),h&&(h.style.display="none"),j=null,f=null}function ue(){de(),M.mouseover&&(window.removeEventListener("mouseover",M.mouseover,!0),M.mouseover=null),M.mouseout&&(window.removeEventListener("mouseout",M.mouseout,!0),M.mouseout=null),M.click&&(window.removeEventListener("click",M.click,!0),M.click=null),document.querySelectorAll(".felo--hover_overlay,.felo--selection_box").forEach(e=>{e.remove()}),w=null,h=null,re=null}function fe(){if(R){ue(),nt();try{document.querySelectorAll("svg *").forEach(e=>{e.style.pointerEvents="none"})}catch(e){console.warn("[FELO-IFRAME] Failed to disable pointer-events on SVG children:",e)}at()}}function nt(){if(!document.body)return;w=document.createElement("div"),w.style.position="absolute",w.style.border="2px dashed #0080FF",w.style.zIndex="1000",w.style.pointerEvents="none",w.style.display="none",w.style.borderRadius="4px",w.style.transition="all 100ms ease-in-out",w.className="felo--hover_overlay",document.body.appendChild(w),h=document.createElement("div"),h.style.position="absolute",h.style.border="2px solid #0080FF",h.style.zIndex="1000",h.style.pointerEvents="none",h.style.display="none",h.style.borderRadius="4px",h.style.transition="all 100ms ease-in-out",h.className="felo--selection_box",document.body.appendChild(h),[{position:"top-left",cursor:"nwse-resize"},{position:"top",cursor:"ns-resize"},{position:"top-right",cursor:"nesw-resize"},{position:"right",cursor:"ew-resize"},{position:"bottom-right",cursor:"nwse-resize"},{position:"bottom",cursor:"ns-resize"},{position:"bottom-left",cursor:"nesw-resize"},{position:"left",cursor:"ew-resize"}].forEach(n=>{let o=document.createElement("div");switch(o.className=`felo--resize-handle felo--resize-${n.position}`,o.style.position="absolute",o.style.width="10px",o.style.height="10px",o.style.backgroundColor="white",o.style.border="2px solid #0080FF",o.style.borderRadius="50%",o.style.cursor=n.cursor,o.style.zIndex="1001",o.style.pointerEvents="auto",n.position){case"top-left":o.style.top="-5px",o.style.left="-5px";break;case"top":o.style.top="-5px",o.style.left="calc(50% - 5px)";break;case"top-right":o.style.top="-5px",o.style.right="-5px";break;case"right":o.style.top="calc(50% - 5px)",o.style.right="-5px";break;case"bottom-right":o.style.bottom="-5px",o.style.right="-5px";break;case"bottom":o.style.bottom="-5px",o.style.left="calc(50% - 5px)";break;case"bottom-left":o.style.bottom="-5px",o.style.left="-5px";break;case"left":o.style.top="calc(50% - 5px)",o.style.left="-5px";break}o.addEventListener("mousedown",i=>{i.stopPropagation(),rt(i,n.position)}),h.appendChild(o)});let t=document.createElement("div");t.className="felo--drag-handle",t.innerHTML='<svg style="width: 16px; height: 16px; stroke: white;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="15 19 12 22 9 19"/><polyline points="19 9 22 12 19 15"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></svg>',t.style.position="absolute",t.style.top="calc(50% - 12px)",t.style.left="calc(50% - 12px)",t.style.width="24px",t.style.height="24px",t.style.backgroundColor="#0080FF",t.style.cursor="move",t.style.zIndex="1002",t.style.borderRadius="50%",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.pointerEvents="auto",t.addEventListener("mousedown",st),h.appendChild(t),j=null,f=null}function ot(){return 1}function it(e){return!1}function st(e){if(!f||!(f instanceof Element))return;e.preventDefault(),e.stopPropagation(),V=!0,document.body.style.cursor="grabbing",O({type:_.ELEMENT_DRAG_START});let t=f.getBoundingClientRect();I=document.createElement("div"),I.className="felo--drag-preview-box",I.style.position="absolute",I.style.border="2px dashed #22C55E",I.style.zIndex="1005",I.style.pointerEvents="none",I.style.borderRadius="4px",I.style.width=`${t.width}px`,I.style.height=`${t.height}px`,I.style.top=`${t.top+window.scrollY}px`,I.style.left=`${t.left+window.scrollX}px`,document.body.appendChild(I);try{let n=window.getComputedStyle(f);n.position==="static"&&(f.style.position="relative");let o=parseFloat(n.top)||0,i=parseFloat(n.left)||0,s=f.style.transform,m=e.clientX,d=e.clientY,r=it(f),y=r?ot():1;console.log("Element in main check:",{isInMain:r,scale:y});let p=l=>{let a=l.clientX-m,S=l.clientY-d,g=t.top+S,c=t.left+a,u=window.innerWidth,E=window.innerHeight;c=Math.max(0,c),g=Math.max(0,g),c=Math.min(u-t.width,c),g=Math.min(E-t.height,g);let H=c-t.left,L=g-t.top;I&&(I.style.transform=`translate(${H}px, ${L}px)`)},N=l=>{let a=W=>{W.stopPropagation(),W.preventDefault()};window.addEventListener("click",a,{capture:!0,once:!0});let S=l.clientX-m,g=l.clientY-d,c=t.top+g,u=t.left+S,E=window.innerWidth,H=window.innerHeight;u=Math.max(0,u),c=Math.max(0,c),u=Math.min(E-t.width,u),c=Math.min(H-t.height,c);let L=u-t.left,x=c-t.top;f.style.transform=s,f.style.top=`${o+x}px`,f.style.left=`${i+L}px`,I&&(I.remove(),I=null),h&&(h.style.display="block"),Q(),xe(f),me(),V=!1,document.body.style.cursor="default",document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",N)};document.addEventListener("mousemove",p),document.addEventListener("mouseup",N)}catch(n){console.error("Error in startDrag:",n),V=!1,document.body.style.cursor="default",I&&(I.remove(),I=null)}}function rt(e,t){if(!(!f||!(f instanceof Element))){e.preventDefault(),e.stopPropagation(),O({type:_.ELEMENT_RESIZE_START}),h&&(h.style.transition="none");try{let n=window.getComputedStyle(f);n.position==="static"&&(f.style.position="relative",n=window.getComputedStyle(f));let o=parseFloat(n.width),i=parseFloat(n.height),s=parseFloat(n.top)||0,m=parseFloat(n.left)||0,d=f.style.transform,r=parseFloat(n.maxWidth),y=parseFloat(n.maxHeight),p=e.clientX,N=e.clientY,l=S=>{let g=S.clientX-p,c=S.clientY-N,u=o,E=i,H=0,L=0;t.includes("right")?u=o+g:t.includes("left")&&(u=o-g,H=g),t.includes("bottom")?E=i+c:t.includes("top")&&(E=i-c,L=c);let x=20;u<x&&(t.includes("left")&&(H+=u-x),u=x),E<x&&(t.includes("top")&&(L+=E-x),E=x),f.style.width=`${u}px`,f.style.height=`${E}px`,f.style.transform=`translate(${H}px, ${L}px)`,Q(),u>r&&(f.style.maxWidth=`${u}px`),E>y&&(f.style.maxHeight=`${E}px`)},a=S=>{f.style.transform=d;let g=S.clientX-p,c=S.clientY-N,u=s,E=m,H=o,L=i;t.includes("top")?(u+=c,L-=c):t.includes("bottom")&&(L+=c),t.includes("left")?(E+=g,H-=g):t.includes("right")&&(H+=g);let x=20;H=Math.max(x,H),L=Math.max(x,L),f.style.top=`${u}px`,f.style.left=`${E}px`,f.style.width=`${H}px`,f.style.height=`${L}px`,Q(),h&&(h.style.transition="all 100ms ease-in-out"),me(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",a)}catch(n){console.error("Error in startResize:",n),h&&(h.style.transition="all 100ms ease-in-out")}}}function Q(){if(!(!(f&&typeof f=="object"&&f.tagName&&f.getBoundingClientRect&&typeof f.getBoundingClientRect=="function")||!h))try{let t=f.getBoundingClientRect();h.style.width=`${t.width}px`,h.style.height=`${t.height}px`,h.style.top=`${t.top+window.scrollY}px`,h.style.left=`${t.left+window.scrollX}px`}catch(t){console.error("Error updating selection box:",t)}}function at(){re||(re=et(n=>{if(!R||k||V)return;let o=n.target,i=o.closest("svg");if(i&&o!==i&&(o=i),o===document.body||o===w||o===h||o===f||o.closest(".felo--hover_overlay")||o.closest(".felo--selection_box"))return;j=o;let s=j.getBoundingClientRect();w&&(w.style.width=`${s.width}px`,w.style.height=`${s.height}px`,w.style.top=`${s.top+window.scrollY}px`,w.style.left=`${s.left+window.scrollX}px`,w.style.display="block")},50));let e=n=>{!R||k||V||n.target===j&&w&&(w.style.display="none",j=null)},t=async n=>{if(!R||k||V)return;n.stopPropagation();let o=n.target,i=o.closest("svg");if(i&&o!==i&&(o=i),o===document.body){Le(),xe(null);return}if(o===w||o===h||o.closest(".felo--hover_overlay")||o.closest(".felo--selection_box"))return;f=o,Q();let s=f.getBoundingClientRect();if(!h)return;h.style.width=`${s.width}px`,h.style.height=`${s.height}px`,h.style.top=`${s.top+window.scrollY}px`,h.style.left=`${s.left+window.scrollX}px`,h.style.display="block",w.style.display="none";let m="container";f.tagName==="IMG"?m="img":f.textContent&&f.textContent.trim().length>0&&(m="text"),xe(f)};M.mouseover=re,M.mouseout=e,M.click=t,document.addEventListener("mouseover",M.mouseover,!0),document.addEventListener("mouseout",M.mouseout,!0),document.addEventListener("click",M.click,!0)}function Le(){h&&(h.remove(),h=null),f=null}let lt=async()=>{try{await Ae(f,"container")}catch(e){console.error("Failed to capture element:",e)}};function xe(e){try{let t=e&&typeof e=="object"&&e.tagName&&e.getBoundingClientRect&&typeof e.getBoundingClientRect=="function";if(e&&!t)return;let n="";try{e.tagName&&typeof e.tagName=="string"?n=e.tagName:e.tagName&&e.tagName.baseVal?n=String(e.tagName.baseVal||""):n="UNKNOWN"}catch(r){console.warn("Failed to get safe tagName:",r),n="UNKNOWN"}let o={};e.attributes&&e.attributes.length>0&&Array.from(e.attributes).forEach(r=>{try{r.name&&r.value!==void 0&&(typeof r.value=="string"||typeof r.value=="number")&&(o[r.name]=r.value)}catch(y){console.warn("Skipping attribute due to access error:",r.name,y)}});let i=null;try{let r=e.getBoundingClientRect();i={width:r.width,height:r.height,top:r.top,left:r.left,right:r.right,bottom:r.bottom}}catch(r){console.warn("Failed to get element rect:",r)}let s="",m="",d="";try{e.className&&typeof e.className=="string"?s=e.className:e.className&&e.className.baseVal&&(s=String(e.className.baseVal||""))}catch(r){console.warn("Failed to get safe className:",r)}try{e.id&&typeof e.id=="string"&&(m=e.id)}catch(r){console.warn("Failed to get safe id:",r)}try{e.textContent&&typeof e.textContent=="string"&&(d=e.textContent.substring(0,100))}catch(r){console.warn("Failed to get safe textContent:",r)}O({type:_.ELEMENT_SELECTION_CHANGE,element:t?{tagName:n,className:s,id:m,textContent:d,attributes:o,rect:i}:null,scaling:1})}catch(t){console.error("Failed to notify selection change:",t)}}function me(){try{O({type:_.TriggerSave})}catch(e){console.error("Failed to notify parent to save:",e)}}function Re(){return new Promise((e,t)=>{if(typeof window.snapdom<"u"){e();return}if(document.getElementById("felo-capture-script")){let d=0,r=setInterval(()=>{d++,typeof window.snapdom<"u"?(clearInterval(r),e()):d>50&&(clearInterval(r),t(new Error("snapdom library loading timeout")))},100);return}let n=document.createElement("script");n.id="felo-capture-script";let o=["https://cdn.jsdelivr.net/npm/@zumer/snapdom/dist/snapdom.min.js","https://unpkg.com/@zumer/snapdom/dist/snapdom.min.js","https://cdnjs.cloudflare.com/ajax/libs/snapdom/1.0.0/snapdom.min.js"],i=0,s=()=>{if(i>=o.length){console.warn("All CDN sources failed to load snapdom library, using fallback method"),window.snapdom={toCanvas:(d,r)=>new Promise((y,p)=>{typeof html2canvas<"u"?html2canvas(d,{useCORS:!0,allowTaint:!0,scale:r.scale||1,backgroundColor:r.backgroundColor||"#ffffff"}).then(y).catch(p):p(new Error("No screenshot library available"))})},e();return}n.src=o[i],console.log(`Trying to load snapdom from: ${o[i]}`)};s();let m=setTimeout(()=>{n.onload=null,n.onerror=null,n.parentNode&&n.parentNode.removeChild(n),i++,s()},8e3);n.onload=function(){clearTimeout(m),setTimeout(()=>{if(typeof window.snapdom<"u")e();else{let d=0,r=setInterval(()=>{d++,typeof window.snapdom<"u"?(clearInterval(r),e()):d>30&&(clearInterval(r),t(new Error("snapdom library failed to initialize properly")))},100)}},200)},n.onerror=function(){clearTimeout(m),n.parentNode&&n.parentNode.removeChild(n),i++,s()},document.head.appendChild(n)})}function ct(e){return new Promise(t=>{let n=new Image;n.onload=()=>t(!0),n.onerror=()=>t(!1),n.src=e,setTimeout(()=>{n.onload=null,n.onerror=null,t(!1)},3e3)})}async function Me(e){let t=e.querySelectorAll("img"),n=[];t.forEach(o=>{let i=o.getAttribute("src");i&&!i.startsWith("data:")&&n.push(ct(i).then(s=>{s||(o.setAttribute("data-original-src",i),o.style.backgroundColor="#f0f0f0",o.style.border="2px dashed #ccc",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.color="#666",o.style.fontSize="12px",o.style.textAlign="center",o.style.minWidth="100px",o.style.minHeight="60px",o.removeAttribute("src"),o.alt="Image not available",o.innerHTML="\u{1F6AB} Image not available")}).catch(s=>{console.warn("Error processing image:",i,s),o.style.backgroundColor="#f0f0f0",o.style.border="2px dashed #ccc",o.removeAttribute("src"),o.alt="Image error"}))});try{await Promise.allSettled(n)}catch(o){console.warn("Error in preprocessImages:",o)}}async function Ae(e,t="container",n={}){if(!e||!(e instanceof Element)){console.error("Please provide a valid DOM element");return}let o=[],i=[];try{typeof window.snapdom>"u"&&await Re(),o=[...document.querySelectorAll(".felo--hover_overlay"),...document.querySelectorAll(".felo--selection_box"),...document.querySelectorAll(".felo--ai_loading")],i=[],o.forEach((C,T)=>{i[T]={},C.style.display!==void 0&&(i[T].display=C.style.display,C.style.display="none")}),await Me(document.body);let s=e.getBoundingClientRect(),m=Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),d=Math.max(document.documentElement.scrollTop,document.body.scrollTop),r=s.left+m,y=s.top+d,p=4,N=document.documentElement.scrollWidth,l=document.documentElement.scrollHeight,a=Math.min(p,r),S=Math.min(p,y),g=Math.min(p,N-(r+s.width)),c=Math.min(p,l-(y+s.height)),u=r-a,E=y-S,H=s.width+a+g,L=s.height+S+c,x=window.devicePixelRatio||1,W=window.snapdom.toCanvas(document.body,{scale:x,compress:!0,fast:!0,embedFonts:!1,backgroundColor:"transparent",timeout:1e4,allowTaint:!0,useCORS:!0,crossOrigin:C=>{try{return C.startsWith(window.location.origin)?"use-credentials":"anonymous"}catch(T){return console.warn("Error handling crossOrigin for URL:",C,T),"anonymous"}},onError:(C,T)=>(console.warn("snapdom encountered an error:",C,"Element:",T),!0),onResourceError:(C,T)=>(console.warn("snapdom resource error:",C,"URL:",T),!0),onProgress:C=>{C.total>0}}),te=new Promise((C,T)=>{setTimeout(()=>T(new Error("Screenshot timeout")),15e3)}),$=await Promise.race([W,te]),X=$.width/x,he=$.height/x,ge=X/N,ne=he/l,q=u*ge,pe=E*ne,Se=H*ge,D=L*ne,A=document.createElement("canvas"),K=Math.max(1,Se*x/2),oe=Math.max(1,D*x/2);A.width=K,A.height=oe,A.getContext("2d").drawImage($,q*x,pe*x,Se*x,D*x,0,0,K,oe);let P=A.toDataURL("image/jpeg",.7),z=null;if(e&&e instanceof Element)try{let C="";try{e.tagName&&typeof e.tagName=="string"?C=e.tagName:e.tagName&&e.tagName.baseVal?C=String(e.tagName.baseVal||""):C="UNKNOWN"}catch(b){console.warn("Failed to get safe tagName during screenshot:",b),C="UNKNOWN"}let T={};e.attributes&&e.attributes.length>0&&Array.from(e.attributes).forEach(b=>{try{b.name&&b.value!==void 0&&(typeof b.value=="string"||typeof b.value=="number")&&(T[b.name]=b.value)}catch(be){console.warn("Skipping attribute during screenshot:",b.name,be)}});let ye=null;try{let b=e.getBoundingClientRect();ye={width:b.width,height:b.height,top:b.top,left:b.left,right:b.right,bottom:b.bottom}}catch(b){console.warn("Failed to get element rect during screenshot:",b)}let ie="",se="",Z="";try{e.className&&typeof e.className=="string"?ie=e.className:e.className&&e.className.baseVal&&(ie=String(e.className.baseVal||""))}catch(b){console.warn("Failed to get safe className during screenshot:",b)}try{e.id&&typeof e.id=="string"&&(se=e.id)}catch(b){console.warn("Failed to get safe id during screenshot:",b)}try{e.textContent&&typeof e.textContent=="string"&&(Z=e.textContent.substring(0,100))}catch(b){console.warn("Failed to get safe textContent during screenshot:",b)}z={tagName:C,className:ie,id:se,textContent:Z,attributes:T,rect:ye}}catch(C){console.warn("Failed to get element info during screenshot:",C)}return O({type:_.ELEMENT_SCREENSHOT,element:z,scaling:1,base64:P,screenshotSuccess:!0,elementType:t,...n}),P}catch(s){console.error("Error during screenshot process with snapdom:",s);let m=null;if(e&&e instanceof Element)try{let d={};e.attributes&&e.attributes.length>0&&Array.from(e.attributes).forEach(a=>{try{a.name&&a.value!==void 0&&(typeof a.value=="string"||typeof a.value=="number")&&(d[a.name]=a.value)}catch(S){console.warn("Skipping attribute during error handling:",a.name,S)}});let r=null;try{let a=e.getBoundingClientRect();r={width:a.width,height:a.height,top:a.top,left:a.left,right:a.right,bottom:a.bottom}}catch(a){console.warn("Failed to get element rect during error handling:",a)}let y="";try{e.tagName&&typeof e.tagName=="string"?y=e.tagName:e.tagName&&e.tagName.baseVal?y=String(e.tagName.baseVal||""):y="UNKNOWN"}catch(a){console.warn("Failed to get safe tagName during error handling:",a)}let p="",N="",l="";try{e.className&&typeof e.className=="string"?p=e.className:e.className&&e.className.baseVal&&(p=String(e.className.baseVal||""))}catch(a){console.warn("Failed to get safe className during error handling:",a)}try{e.id&&typeof e.id=="string"&&(N=e.id)}catch(a){console.warn("Failed to get safe id during error handling:",a)}try{e.textContent&&typeof e.textContent=="string"&&(l=e.textContent.substring(0,100))}catch(a){console.warn("Failed to get safe textContent during error handling:",a)}m={tagName:y,className:p,id:N,textContent:l,attributes:d,rect:r}}catch(d){console.warn("Failed to get element info during error handling:",d)}O({type:_.ELEMENT_SCREENSHOT,element:m,scaling:1,screenshotSuccess:!1,screenshotError:s.message,elementType:t,...n})}finally{try{o.forEach((s,m)=>{i[m]&&Object.keys(i[m]).forEach(d=>{s.style[d]=i[m][d]})})}catch(s){console.error("Error restoring attributes:",s)}}}async function dt(e={}){let t=[],n=[];try{typeof window.snapdom>"u"&&await Re(),t=[...document.querySelectorAll(".felo--hover_overlay"),...document.querySelectorAll(".felo--selection_box"),...document.querySelectorAll(".felo--ai_loading")],n=[],t.forEach((c,u)=>{n[u]={},c.style.display!==void 0&&(n[u].display=c.style.display,c.style.display="none")}),await Me(document.body);let o=document.documentElement.scrollWidth,i=document.documentElement.scrollHeight,s=window.devicePixelRatio||1,m=window.snapdom.toCanvas(document.body,{scale:s,compress:!0,fast:!0,embedFonts:!1,backgroundColor:"transparent",timeout:1e4,allowTaint:!0,useCORS:!0,crossOrigin:c=>{try{return c.startsWith(window.location.origin)?"use-credentials":"anonymous"}catch(u){return console.warn("Error handling crossOrigin for URL:",c,u),"anonymous"}},onError:(c,u)=>(console.warn("snapdom encountered an error:",c,"Element:",u),!0),onResourceError:(c,u)=>(console.warn("snapdom resource error:",c,"URL:",u),!0),onProgress:c=>{c.total>0}}),d=new Promise((c,u)=>{setTimeout(()=>u(new Error("Screenshot timeout")),15e3)}),r=await Promise.race([m,d]),y=document.createElement("canvas"),p=1920,N=1080,{width:l,height:a}=r;if(l>p||a>N){let c=Math.min(p/l,N/a);l=l*c,a=a*c}y.width=l,y.height=a,y.getContext("2d").drawImage(r,0,0,l,a);let g=y.toDataURL("image/jpeg",.8);return O({type:_.ELEMENT_SCREENSHOT,element:{tagName:"BODY",className:"full-page",id:"full-page-screenshot",textContent:"Full page screenshot",attributes:{},rect:{width:o,height:i,top:0,left:0}},scaling:1,base64:g,screenshotSuccess:!0,elementType:"page",...e}),g}catch(o){return console.error("Error during full page screenshot process:",o),O({type:_.ELEMENT_SCREENSHOT,element:{tagName:"BODY",className:"full-page",id:"full-page-screenshot",textContent:"Full page screenshot",attributes:{},rect:{width:0,height:0,top:0,left:0}},scaling:1,screenshotSuccess:!1,screenshotError:o.message,elementType:"page",...e}),null}finally{try{t.forEach((o,i)=>{n[i]&&Object.keys(n[i]).forEach(s=>{o.style[s]=n[i][s]})})}catch(o){console.error("Error restoring attributes:",o)}}}window.clearSelection=Le,window.getSelectedElement=()=>f,window.initHoverSelection=fe,window.hasEditPermission=()=>R,window.cleanupHoverSelection=de,window.notifyParentToSave=me,window.captureElementToBase64=Ae,window.captureFullPageToBase64=dt,window.reinitializeIframe=Te,window.fullReinitialize=He;let Pe=()=>{let e=document.querySelector(".felo--selection_box"),t=document.querySelector(".felo--ai_loading");if(f&&e&&Q(),t){let n=t.dataset.targetElementId;if(n){let o=document.querySelector(`[data-element-id="${n}"]`);if(o&&o instanceof Element){let i=o.getBoundingClientRect();t.style.width=`${i.width}px`,t.style.height=`${i.height}px`,t.style.left=`${i.left+window.scrollX}px`,t.style.top=`${i.top+window.scrollY}px`}}}},ee=()=>{document.querySelectorAll(".felo--ai_loading").forEach(t=>{t.remove()}),F=null,k=!1,document.body&&(document.body.contentEditable=R?"true":"false")},Fe=(e,t)=>{ee(),F=document.createElement("div");let n=document.querySelector(`[data-element-id="${e}"]`);if(!n||!(n instanceof Element))return;k=!0,document.body&&(document.body.contentEditable="false");let o=n.getBoundingClientRect();F.classList.add("felo--ai_loading"),F.dataset.targetElementId=e,F.style.width=`${o.width}px`,F.style.height=`${o.height}px`,F.style.position="absolute",F.style.left=`${o.left+window.scrollX}px`,F.style.top=`${o.top+window.scrollY}px`,F.style.zIndex="9999",F.style.borderRadius="4px",F.innerHTML=`
    <style>
      .felo-loader-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
    <div style="display: flex; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.8); border-radius: 4px;">
      <div style="position: relative; display: flex; align-items: center; justify-content: center;">
        <div class="felo-loader-spin" style="width: 48px; height: 48px; border-radius: 50%; border: 4px solid transparent; border-top-color: #3b82f6;"></div>
      </div>
      ${t.title?`<p style="margin-top: 1rem; color: #111827;">${t.title}</p>`:""}
    </div>
  `,document.body.appendChild(F)};function ut(e,t){let n=document.querySelector(`img[data-element-id="${e}"]`);if(!n||n.tagName!=="IMG"){console.warn(`Image element with id ${e} not found.`);return}Fe(e,{title:""}),n.onload=()=>{ee(),O({type:_.IMAGE_REPLACED,elementId:e,imageUrl:t}),me()},n.onerror=()=>{console.error(`Failed to load image: ${t}`),ee()},n.src=t}let _e=e=>{if(!ke(e.origin))return;let{type:t,data:n}=e.data;t==="HIDE_LOADING"?ee():t==="SHOW_LOADING"?Fe(n.element_id,n.options):t==="EDIT_PERMISSION_RESPONSE"?(tt(n.hasPermission),Ce=n.pageId):t==="CLEANUP_HOVER_SELECTION"?de():t==="REINITIALIZE_IFRAME"?Te():t===_.FULL_REINITIALIZE?He():t===_.SetEditingPaused&&(k=n.paused,document.body&&(document.body.contentEditable=k?"false":R?"true":"false"),k&&de())};window.addEventListener("beforeunload",()=>{ue(),window.removeEventListener("resize",Pe),window.removeEventListener("message",_e)}),window.addEventListener("message",_e),window.addEventListener("load",Ie),window.addEventListener("resize",Pe),ae(),ee(),window.fixHeight=le,window.sendHeight=ae,window.resizeEcharts=Ee,window.sendCurrentSelectedElementScreenshot=lt,window.replaceImageWithLoading=ut,document.addEventListener("mouseleave",()=>{w&&(w.style.display="none",j=null)})})();})();
